!function(t){$clip=$Clip=t.$Clip={},$Clip.Main=function(t,i){this.$btn=t,this.init(i)},$Clip.Main.prototype={_Config:{canvasId:"DC_canvas_clip_"+(new Date).getTime(),clipboxId:"DC_clipbox_"+(new Date).getTime(),width:125,height:125,borderColor:"rgb(247, 251, 0)",bgOpcity:.5,btn:{ok:{btnTitle:"确定",callback:function(){}},canel:{btnTitle:"取消",callback:function(){}}}},init:function(i){this._Config.width=i.width||$Clip._Config.width,this._Config.height=i.height||$Clip._Config.height,this.height=$(t).height(),this.width=$(t).width()},addEvent:function(){var t=this,i=$("#"+this._Config.clipboxId+">.Dc_clipbox_Canvasbox>.Dc_clipbox_bgMask");$(".Dc_clipbox_btnbox").height(),$(".Dc_clipbox_btnbox>.Dc_clipbox_btn_ok").on("click",function(){var i={},a=(t.width-t._Config.width)/2,h=(t.height-t._Config.height)/2;i.img=t.draw.getImageData(a,h,t._Config.width,t._Config.height);var n=document.createElement("canvas");$(n).width(t._Config.width),$(n).height(t._Config.height);var s=n.getContext("2d");s.putImageData(i.img,0,0,t._Config.width,t._Config.height),console.log(n.toDataURL("image/png")),t._Config.btn.ok.callback.call()}).html(t._Config.btn.ok.btnTitle),this.event=new $Clip.EventTool({elem:i,touchStart:function(){},touchEnd:function(){t.draw.lastX=null,t.draw.lastY=null,t.draw.lastDistance=null},touchMove:{singlePoint:function(){var i=0,a=0;void 0===t.draw.lastX||null===t.draw.lastX?(i=this.currentX-this.startX,a=this.currentY-this.startY):(i=this.currentX-t.draw.lastX,a=this.currentY-t.draw.lastY),t.draw.lastX=this.currentX,t.draw.lastY=this.currentY,t.draw.translate(i,a)},multiPointFunc:function(){if(void 0===t.draw.lastDistance||null===t.draw.lastDistance)distance=t.getDistance(this.startX,this.current2X,this.startY,this.current2Y),t.draw.lastDistance=distance;else{distance=t.getDistance(this.currentX,this.current2X,this.currentY,this.current2Y);var i=distance-t.draw.lastDistance;t.draw.lastDistance=distance,t.draw.scale(i)}}}}).addEvents()},getDistance:function(t,i,a,h){var n=i-t,s=h-a;return Math.sqrt(n*n+s*s)},bulidHtml:function(){var t='<div id="'+this._Config.clipboxId+'" class="Dc_clipbox_dialog">';t+='	<div class="Dc_clipbox_Canvasbox">',t+="	</div>",t+='	<div class="Dc_clipbox_btnbox">',t+='		<button type="button" class="Dc_clipbox_btn Dc_clipbox_btn_ok">确认</button>',t+='		<button type="button" class="Dc_clipbox_btn Dc_clipbox_btn_canel">取消</button>',t+="	</div>",t+="</div>",$("body").append(t)},createClipbox:function(){return this.bulidHtml(),this.$clipBox=$(this._Config.clipboxId),this.createCanavs(),this.$clipBox},createBjMask:function(){this.$clipBox=$("#"+this._Config.clipboxId);var t=$("#"+this._Config.clipboxId+">.Dc_clipbox_btnbox");this.btnHeight=t.height();var i=document.createElement("div");$(i).css({width:this._Config.width+"px",height:this._Config.height+"px","border-color":this._Config.borderColor,"border-style":"solid","border-width":"1px",position:"absolute",top:"50%",left:"50%","margin-left":-this._Config.width/2-1+"px","margin-top":-this._Config.height/2+"px","z-index":100}),this.$clipBox.find(".Dc_clipbox_Canvasbox").append(i);var a=(this.height-this.btnHeight-this._Config.height)/2,h=document.createElement("div");$(h).css({width:this.width+"px",height:(this.height-this.btnHeight-this._Config.height)/2+"px","background-color":"rgba(0,0,0,0.8)",position:"absolute",top:"0px",left:"0px","z-index":99}),this.$clipBox.find(".Dc_clipbox_Canvasbox").append(h);var n=document.createElement("div");$(n).css({width:(this.width-this._Config.width)/2+"px",height:this._Config.height+"px","background-color":"rgba(0,0,0,0.8)",position:"absolute",top:a+"px",left:"0px","z-index":99}),this.$clipBox.find(".Dc_clipbox_Canvasbox").append(n);var s=document.createElement("div");$(s).css({width:this.width+"px",height:(this.height-this.btnHeight-this._Config.height)/2+"px","background-color":"rgba(0,0,0,0.8)",position:"absolute",top:this._Config.height+(this.height-this.btnHeight-this._Config.height)/2+"px",left:"0px","z-index":99}),this.$clipBox.find(".Dc_clipbox_Canvasbox").append(s);var e=document.createElement("div");$(e).css({width:(this.width-this._Config.width)/2+"px",height:this._Config.height+"px","background-color":"rgba(0,0,0,0.8)",position:"absolute",top:a+"px",right:"0px","z-index":99}),this.$clipBox.append(e);var o=document.createElement("div");$(o).css({width:this.width+"px",height:this.height-this.btnHeight+"px","background-color":"rgba(55,255,0.8)",position:"absolute",top:"0px",left:"0px","z-index":101}).addClass("Dc_clipbox_bgMask"),this.$clipBox.find(".Dc_clipbox_Canvasbox").append(o)},createCanavs:function(){var t=$("#"+this._Config.clipboxId+">.Dc_clipbox_Canvasbox"),i=$("#"+this._Config.clipboxId+">.Dc_clipbox_btnbox");t.width(this.width),t.height(this.height-i.height()),this._Config.canvasWidth=t.width(),this._Config.canvasHeight=t.height(),this._Config.canvasCss={},this.draw=new $Clip.DrawCanvas(this._Config,t),this.draw.drawImage(0,0,this.width,this.height)},getImageData:function(t){t.call(this.btn,data)},createFileInput:function(){var t=this;this.fileInput=document.createElement("input"),this.fileInput.setAttribute("type","file"),this.fileInput.setAttribute("accept","image/*"),this.fileInput.setAttribute("id","Dc_filebtn_input"+(new Date).getTime()),this.$btn.append(this.fileInput),this.$btn.css({position:"relative"}),$(this.fileInput).css({position:"absolute",width:"100%",height:"100%",display:"block",top:"0px",left:"0px",opacity:"0","-webkit-opacity":"0"}),$(this.fileInput).on("change",function(i){t.reader=new FileReader,this.upfile=t.fileInput.files[0],t.reader.readAsDataURL(this.upfile),t.reader.onload=function(i){t._Config.imgpath=i.target.result,t.createClipbox(),t.createBjMask(),t.addEvent()}})}},$Clip.setClipImage=function(t,i){var a=new $Clip.Main(t,i);a.createFileInput()}}(window),function(){$Clip.DrawCanvas=function(t,i){this.drawConfig=t,this.baseClipBox=i,this.createCanvas()},$Clip.DrawCanvas.prototype={drawImage:function(t,i,a,h){var n=this,s=new Image;s.onload=function(){var e=s.width,o=s.height;e>=o?(a=n.baseClipBox.width(),h=n.baseClipBox.width()/e*o,h<n.drawConfig.canvasHeight&&(a=n.drawConfig.canvasHeight/h*a,h=n.drawConfig.canvasHeight),i=(n.baseClipBox.height()-h)/2):(h=n.baseClipBox.height(),a=n.baseClipBox.height()/o*e,a<n.drawConfig.canvasWidth&&(h=n.drawConfig.canvasWidth/a*h,a=n.drawConfig.canvasWidth),t=(n.baseClipBox.width()-a)/2),n.imgData={img:s,x:t,y:i,width:a,height:h},n.ctx.fillStyle="#555555",n.ctx.fillRect(0,0,n.drawConfig.width,n.drawConfig.height),n.ctx.save(),n.ctx.drawImage(s,t,i,a,h),n.ctx.restore()},s.src=this.drawConfig.imgpath},translate:function(t,i){this.imgData.x+t>(this.drawConfig.canvasWidth-this.drawConfig.width)/2||Math.abs(this.imgData.x+this.imgData.width+t)<(this.drawConfig.canvasWidth-this.drawConfig.width)/2+this.drawConfig.width||this.imgData.y+i>(this.drawConfig.canvasHeight-this.drawConfig.height)/2||Math.abs(this.imgData.y+this.imgData.height+i)<(this.drawConfig.canvasHeight-this.drawConfig.height)/2+this.drawConfig.height||(this.imgData.x+=t,this.imgData.y+=i,this.ctx.fillStyle="#555555",this.ctx.fillRect(0,0,this.drawConfig.canvasWidth,this.drawConfig.canvasHeight),this.ctx.save(),this.ctx.drawImage(this.imgData.img,this.imgData.x,this.imgData.y,this.imgData.width,this.imgData.height),this.ctx.restore(),this.ctx.save())},scale:function(t){this.imgData.x-t>(this.drawConfig.canvasWidth-this.drawConfig.width)/2||Math.abs(this.imgData.x+this.imgData.width+t-t)<(this.drawConfig.canvasWidth-this.drawConfig.width)/2+this.drawConfig.width||this.imgData.y-t>(this.drawConfig.canvasHeight-this.drawConfig.height)/2||Math.abs(this.imgData.y+this.imgData.height+t-t)<(this.drawConfig.canvasHeight-this.drawConfig.height)/2+this.drawConfig.height||(this.imgData.x-=t,this.imgData.y-=t,this.imgData.width+=t,this.imgData.height+=t,this.ctx.fillStyle="#555555",this.ctx.fillRect(0,0,this.drawConfig.canvasWidth,this.drawConfig.canvasHeight),this.ctx.save(),this.ctx.drawImage(this.imgData.img,this.imgData.x,this.imgData.y,this.imgData.width,this.imgData.height),this.ctx.restore(),this.ctx.save())},createCanvas:function(){return this.canvas=document.createElement("canvas"),this.canvas.setAttribute("width",this.drawConfig.canvasWidth),this.canvas.setAttribute("height",this.drawConfig.canvasHeight),this.canvas.setAttribute("id",this.drawConfig.canvasId),$(this.canvas).css(this.drawConfig.canvasCss),$(this.baseClipBox).append(this.canvas),this.ctx=this.canvas.getContext("2d"),this},getImageData:function(t,i,a,h){return this.ctx.getImageData(t,i,a,h)}}}(),function(){$Clip.EventTool=function(t){this.configMap=t,this.elem=t.elem},$Clip.EventTool.prototype={op:{touchCount:1,startX:0,startY:0,currentX:0,currentY:0,current2X:0,current2Y:0},touchMove:function(t){this.op.touchCount=t.touches.length,this.op.currentX=t.touches[0].clientX,this.op.currentY=t.touches[0].clientY,this.op.touchCount>1?(this.op.current2X=t.touches[1].clientX,this.op.current2Y=t.touches[1].clientY,this.configMap.touchMove.multiPointFunc.call(this.op)):this.configMap.touchMove.singlePoint.call(this.op)},touchStart:function(t){this.op.touchCount=t.touches,this.op.startX=t.touches[0].clientX,this.op.startY=t.touches[0].clientY,this.op.touchCount>1&&(this.op.start2X=t.touches[1].clientX,this.op.start2Y=t.touches[1].clientY),this.configMap.touchStart.call(this.op)},touchEnd:function(t){this.configMap.touchEnd.call(this.op)},addEvents:function(){var t=this;this.elem.on("touchstart",function(i){t.touchStart.call(t,i)}),this.elem.on("touchmove",function(i){i.preventDefault(),i.stopPropagation(),t.touchMove.call(t,i)}),this.elem.on("touchend",function(i){t.touchEnd.call(t,i)})}}}();
