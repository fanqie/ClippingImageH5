!function(t){$clip=$Clip=t.$Clip={},$Clip.Main=function(t,i){this.$btn=t,this.init(i)},$Clip.Main.prototype={_Config:{canvasId:"DC_canvas_clip_"+(new Date).getTime(),clipboxId:"DC_clipbox_"+(new Date).getTime(),width:125,height:125,borderColor:"rgb(247, 251, 0)",bgOpcity:.5,btn:{ok:{btnTitle:"确定",callback:function(){}},canel:{btnTitle:"取消",callback:function(){}}}},init:function(i){this._Config.width=i.width||$Clip._Config.width,this._Config.height=i.height||$Clip._Config.height,this.height=$(t).height(),this.width=$(t).width()},addEvent:function(){var t=this,i=$("#"+this._Config.clipboxId+">.Dc_clipbox_bgMask");this.event=new $Clip.EventTool({elem:i,touchStart:function(){},touchEnd:function(){t.draw.lastX=this.currentX,t.draw.lastY=this.currentY},touchMove:{singlePoint:function(){var i=0,n=0;void 0==t.draw.lastX?(i=this.currentX-this.startX,n=this.currentY-this.startY):(i=this.currentX-this.lastX,n=this.currentY-this.lastY),t.draw.lastX=this.currentX,t.draw.lastY=this.currentY,t.draw.translate(i,n)},multiPointFunc:function(){}}}).addEvents()},bulidHtml:function(){var t='<div id="'+this._Config.clipboxId+'" class="Dc_clipbox_dialog">';t+='	<div class="Dc_clipbox_Canvasbox">',t+="	</div>",t+='	<div class="Dc_clipbox_btnbox">',t+='		<button type="button" class="Dc_clipbox_btn Dc_clipbox_btn_ok">确认</button>',t+='		<button type="button" class="Dc_clipbox_btn Dc_clipbox_btn_canel">取消</button>',t+="	</div>",t+="</div>",$("body").append(t)},createClipbox:function(){return this.bulidHtml(),this.$clipBox=$(this._Config.clipboxId),this.createCanavs(),this.$clipBox},createBjMask:function(){this.$clipBox=$("#"+this._Config.clipboxId);var t=$("#"+this._Config.clipboxId+">.Dc_clipbox_btnbox");this.btnHeight=t.height();var i=document.createElement("div");$(i).css({width:this._Config.width+"px",height:this._Config.height+"px","border-color":this._Config.borderColor,"border-style":"solid","border-width":"1px",position:"absolute",top:"50%",left:"50%","margin-left":-this._Config.width/2-1+"px","margin-top":(-this._Config.height-this.btnHeight)/2-1+"px","z-index":100}),this.$clipBox.append(i);var n=(this.height-this.btnHeight-this._Config.height)/2,e=document.createElement("div");$(e).css({width:this.width+"px",height:(this.height-this.btnHeight-this._Config.height)/2+"px","background-color":"rgba(0,0,0,0.8)",position:"absolute",top:"0px",left:"0px","z-index":99}),this.$clipBox.append(e);var h=document.createElement("div");$(h).css({width:(this.width-this._Config.width)/2+"px",height:this._Config.height+"px","background-color":"rgba(0,0,0,0.8)",position:"absolute",top:n+"px",left:"0px","z-index":99}),this.$clipBox.append(h);var o=document.createElement("div");$(o).css({width:this.width+"px",height:(this.height-this.btnHeight-this._Config.height)/2+"px","background-color":"rgba(0,0,0,0.8)",position:"absolute",top:this._Config.height+(this.height-this.btnHeight-this._Config.height)/2+"px",left:"0px","z-index":99}),this.$clipBox.append(o);var a=document.createElement("div");$(a).css({width:(this.width-this._Config.width)/2+"px",height:this._Config.height+"px","background-color":"rgba(0,0,0,0.8)",position:"absolute",top:n+"px",right:"0px","z-index":99}),this.$clipBox.append(a);var s=document.createElement("div");$(s).css({width:this.width+"px",height:this.height-this.btnHeight+"px","background-color":"rgba(55,255,0.8)",position:"absolute",top:"0px",left:"0px","z-index":101}).addClass("Dc_clipbox_bgMask"),this.$clipBox.append(s)},createCanavs:function(){var t=$("#"+this._Config.clipboxId+">.Dc_clipbox_Canvasbox"),i=$("#"+this._Config.clipboxId+">.Dc_clipbox_btnbox");t.width(this.width),t.height(this.height-i.height()),this._Config.canvasWidth=t.width(),this._Config.canvasHeight=t.height()-i.height(),this._Config.canvasCss={},this.draw=new $Clip.DrawCanvas(this._Config,t),this.draw.drawImage(0,0,this.width,this.height)},getImageData:function(t){t.call(this.btn,data)},createFileInput:function(){var t=this;this.fileInput=document.createElement("input"),this.fileInput.setAttribute("type","file"),this.fileInput.setAttribute("accept","image/*"),this.fileInput.setAttribute("id","Dc_filebtn_input"+(new Date).getTime()),this.$btn.append(this.fileInput),this.$btn.css({position:"relative"}),$(this.fileInput).css({position:"absolute",width:"100%",height:"100%",display:"block",top:"0px",left:"0px",opacity:"0","-webkit-opacity":"0"}),$(this.fileInput).on("change",function(i){t.reader=new FileReader,this.upfile=t.fileInput.files[0],t.reader.readAsDataURL(this.upfile),t.reader.onload=function(i){t._Config.imgpath=i.target.result,t.createClipbox(),t.createBjMask(),t.addEvent()}})}},$Clip.setClipImage=function(t,i){var n=new $Clip.Main(t,i);n.createFileInput()}}(window),function(){$Clip.DrawCanvas=function(t,i){this.drawConfig=t,this.baseClipBox=i,this.createCanvas()},$Clip.DrawCanvas.prototype={drawImage:function(t,i,n,e){var h=this,o=new Image;o.onload=function(){var a=o.width,s=o.height;a>=s?(n=h.baseClipBox.width(),e=h.baseClipBox.width()/a*s,e<h.drawConfig.canvasHeight&&(n=h.drawConfig.canvasHeight/e*n,e=h.drawConfig.canvasHeight),i=(h.baseClipBox.height()-e)/2):(e=h.baseClipBox.height(),n=h.baseClipBox.height()/s*a,n<h.drawConfig.canvasWidth&&(e=h.drawConfig.canvasWidth/n*e,n=h.drawConfig.canvasWidth),t=(h.baseClipBox.width()-n)/2),h.imgData={img:o,x:t,y:i,width:n,height:e},h.ctx.fillStyle="#555555",h.ctx.fillRect(0,0,h.drawConfig.width,h.drawConfig.height),h.ctx.save(),h.ctx.drawImage(o,t,i,n,e),h.ctx.restore()},o.src=this.drawConfig.imgpath},translate:function(t,i){console.log(this.imgData.x+t),this.imgData.x+=t,this.imgData.y+=i,this.ctx.fillStyle="#555555",this.ctx.fillRect(0,0,this.drawConfig.canvasWidth,this.drawConfig.canvasHeight),this.ctx.save(),this.ctx.drawImage(this.imgData.img,this.imgData.x,this.imgData.y,this.imgData.width,this.imgData.height),this.ctx.restore()},createCanvas:function(){return this.canvas=document.createElement("canvas"),this.canvas.setAttribute("width",this.drawConfig.canvasWidth),this.canvas.setAttribute("height",this.drawConfig.canvasHeight),this.canvas.setAttribute("id",this.drawConfig.canvasId),$(this.canvas).css(this.drawConfig.canvasCss),$(this.baseClipBox).append(this.canvas),this.ctx=this.canvas.getContext("2d"),this},getImageData:function(t,i,n,e){return this.ctx.getImageData(t,i,n,e)}}}(),function(){$Clip.EventTool=function(t){this.configMap=t,this.elem=t.elem},$Clip.EventTool.prototype={op:{touchCount:1,startX:0,startY:0,currentX:0,currentY:0,current2X:0,current2Y:0},touchMove:function(t){this.op.currentX=t.touches[0].clientX,this.op.currentY=t.touches[0].clientY,this.op.touchCount>1?(this.op.current2X=t.touches[1].clientX,this.op.current2Y=t.touches[1].clientY,this.configMap.touchMove.multiPointFunc.call(this.op)):this.configMap.touchMove.singlePoint.call(this.op)},touchStart:function(t){this.op.touchCount=t.touches,this.op.startX=t.touches[0].clientX,this.op.touchCount>1&&(this.op.startY=t.touches[0].clientY),this.configMap.touchStart.call(this.op)},touchEnd:function(t){this.configMap.touchEnd.call(this.op)},addEvents:function(){var t=this;this.elem.on("touchstart",function(i){i.stopPropagation(),t.touchStart.call(t,i)}),this.elem.on("touchmove",function(i){i.stopPropagation(),t.touchMove.call(t,i)}),this.elem.on("touchend",function(i){i.stopPropagation(),t.touchEnd.call(t,i)})}}}();
